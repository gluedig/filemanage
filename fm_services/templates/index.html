<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<!-- 
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>
-->
</head>
<body>
<h2 id="register">MAC: {{client_mac}}</h2>
<h2 id="login">Logging in..</h2>

<script>
function register_mac() {
	var mac = '{{client_mac}}';
	if ( mac == 'unknown') {
		return;
	}
	
	$.ajax({
		url: "/client/register/{{client_mac}}",
		context: document.body,
		dataType: 'json'
	})
	.success(function(data, status, jqxhr) {
		$('#register').append(" registered");
	});
};


function login() {
	$.ajax({
		url: "/user/login",
		context: document.body,
		dataType: 'json'
	})
	.success(function(data, status, jqxhr) {
		if (jqxhr.responseJSON.length) {
			
		
			resp = jqxhr.responseJSON[0];
			console.log(resp)
		
			$('#login').text("User logged-in");
			get_user(resp);			
			find_monitor();
		} else {
			$('#login').text('User not logged-in');
			$(this).append('please <a href="/user/create_form">create an account</a>');
			$(this).append(' or <a href="/user/login_form">login</a>');
		}
	});
};

function get_user(user_id) {
	$.ajax({
		url: "/user/"+user_id,
		context: document.body,
		dataType: 'json'
	})
	.success(function(data, status, jqxhr) {
			resp = jqxhr.responseJSON[0];
			console.log(resp)
		
			var email = resp.email;
			var id = resp.id;
			
			$(this).append('<h2>Welcome '+email+'</h2>');
			$(this).append('<h2>user id: '+id+'</h2>');
			if (resp.image != "") {
				$(this).append('<img src='+resp.image+'/>');
			}
	});
	
};

function find_monitor() {
	$.ajax({
		url: "/monitor/find/{{client_mac}}",
		context: document.body,
		dataType: 'text'
	})
	.success(function(data, status, jqxhr) {
		console.log(data)
		var monitor = data;
		$("#not_found").remove();
		$(this).append('<h2>Found you through monitor: <a href="{{sockjs_url}}'+monitor+'">'+monitor+'</a></h2>');
	})
	.error(function(jqxhr, status, error) {
		if ( $("#not_found").length == 0) {
			$(this).append('<h2 id="not_found">Cannot find you through any monitor, will try again.</h2>');
		}
		setTimeout(function(){find_monitor()}, 10000);
	});
};

$(document).ready(
	function(){
		register_mac();
		login();	
	}
); 
</script>

</body>
</html>
